# Platform-independent tt-metal build
ARG BASE_IMAGE
FROM ${BASE_IMAGE} AS builder

ARG CONAN_PROFILE

# Set up environment
ENV TT_METAL_HOME=/tt-metal
ENV PYTHONPATH=/tt-metal
ENV HOME="/root"
ENV PATH_FIRST="$PATH"

WORKDIR $HOME

# Create temporary virtual environment for initial conan setup
ENV VIRTUAL_ENV=/root/tt-metal-virtualenv-tmp
ENV PATH="$VIRTUAL_ENV/bin:$PATH_FIRST"
RUN python3 -m venv $VIRTUAL_ENV

# Install and configure conan
RUN pip3 install conan
RUN conan profile detect --force

# Copy and apply the conan profile
COPY ${CONAN_PROFILE} /tmp/profile
RUN cp /tmp/profile $(conan profile path default)
RUN git config --global --add safe.directory /workspace
RUN conan profile show

# Copy minimal files for conan dependency installation
WORKDIR /tt-conan
COPY .git /tt-conan/.git
COPY conanfile.py /tt-conan/conanfile.py
COPY /tt_metal/sfpi-version.sh /opt/tt_metal_infra/scripts/docker/sfpi-version.sh

# Install conan dependencies
RUN conan install . --build=missing -cc core.net.http:timeout=240

# Create final virtual environment with python3.10 if available from conan
RUN . .conan-build/Release/generators/conanrun.sh && \
    python3.10 -m venv /root/tt-metal-virtualenv

# Switch to final virtual environment
ENV VIRTUAL_ENV=/root/tt-metal-virtualenv
ENV PATH="$VIRTUAL_ENV/bin:$PATH_FIRST"

# Install conan in the final virtual environment
RUN pip3 install conan

# Copy the full tt-metal source
WORKDIR /tt-metal
COPY . /tt-metal

# Default command
CMD ["/bin/bash"]
